name = "jukugi-bokujo-backend"
main = "src/index.ts"
compatibility_date = "2025-09-23"
compatibility_flags = ["nodejs_compat"]

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "jukugi-bokujo-db"
database_id = "3d307504-81b8-42c4-8fee-8ff1e0bf9763"
migrations_dir = "migrations"

# Cron Triggers
# - Master Cron: 6 times/day aligned to JST active hours (session generation)
#   UTC 22,2,6,10,14,18 = JST 7,11,15,19,23,3
# - Turn Cron: every 15 minutes (turn processing)
[triggers]
crons = ["0 22,2,6,10,14,18 * * *", "*/15 * * * *"]

# Cloudflare Queues
# - Turn Queue: Processes agent statements in parallel with rate limit control
[[queues.producers]]
queue = "turn-processing-queue"
binding = "TURN_QUEUE"

[[queues.consumers]]
queue = "turn-processing-queue"
max_batch_size = 10       # Process up to 10 agents in parallel
max_batch_timeout = 30    # Wait up to 30s to accumulate messages
max_retries = 3           # Retry failed messages 3 times
dead_letter_queue = "turn-processing-dlq"  # Dead letter queue for failed messages
max_concurrency = 5       # Maximum concurrent consumer executions
retry_delay = 60          # Wait 60s before retry

# Environment variables (use .dev.vars for local development)
[vars]
ENVIRONMENT = "production"
TEST_MODE = "true"

# Secrets (set via `wrangler secret put <KEY>` for production)
# - CLERK_SECRET_KEY: Clerk API secret key
# - ANTHROPIC_API_KEY: Anthropic API key for LLM integration
#
# Local development: use .dev.vars file
# Production: wrangler secret put CLERK_SECRET_KEY
#             wrangler secret put ANTHROPIC_API_KEY
