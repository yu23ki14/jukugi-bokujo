# Backend - Hono + Cloudflare Workers

## Setup

1. Install dependencies from the root:
   ```bash
   cd ../.. && pnpm install
   ```

2. Login to Cloudflare:
   ```bash
   pnpm wrangler login
   ```

3. Create D1 database:
   ```bash
   pnpm wrangler d1 create jukugi-bokujo-db
   ```
   Copy the `database_id` from the output and update `wrangler.toml`

4. Run migrations:
   ```bash
   pnpm wrangler d1 execute jukugi-bokujo-db --local --file=./migrations/0001_initial.sql
   ```

5. Copy environment variables:
   ```bash
   cp .dev.vars.example .dev.vars
   ```

6. Edit `.dev.vars` and add your keys:
   ```bash
   CLERK_SECRET_KEY=sk_test_...        # From Clerk Dashboard
   ANTHROPIC_API_KEY=sk-ant-...        # From Anthropic Console
   ENVIRONMENT=development
   ```

## Development

### Local Development

```bash
pnpm dev
```

### Docker Development

From the root directory:

```bash
# Start all services
docker-compose up

# Or start only backend
docker-compose up backend

# Rebuild after package.json changes
docker-compose up -d --build backend

# Clean start (remove volumes and rebuild)
docker-compose down -v && docker-compose up -d backend
```

The API will be available at http://localhost:8787

**Features**:
- **Auto-migration**: D1 migrations run automatically on container startup
- **No manual setup**: Just `docker-compose up` and start developing
- Wrangler 4 binds to `0.0.0.0` for Docker compatibility

**Note**: Local D1 database is stored in Docker volume `backend_wrangler` and persists across restarts.

## Deployment

Deploy to Cloudflare Workers:

```bash
# Create production database
pnpm wrangler d1 create jukugi-bokujo-db-production

# Update wrangler.toml with production database_id

# Run production migrations
pnpm wrangler d1 execute jukugi-bokujo-db-production --remote --file=./migrations/0001_initial.sql

# Deploy
pnpm deploy
```

## Testing Cron Triggers

```bash
curl "http://localhost:8787/__scheduled?cron=*+*+*+*+*"
```

## Docker Build (Development Only)

```bash
docker build -f Dockerfile -t jukugi-bokujo-backend:dev --target development ../..
```

Note: Production deployment is done via `wrangler deploy` to Cloudflare Workers.

## Tech Stack

- **Framework**: Hono 4.11
- **Runtime**: Cloudflare Workers with `nodejs_compat` compatibility flag
- **Database**: Cloudflare D1 (SQLite)
- **CLI**: Wrangler 4.63
- **Language**: TypeScript 5.7

## Important Notes

### Wrangler 4 Migration

This project uses Wrangler 4 with the following updates:
- `nodejs_compat` compatibility flag instead of legacy `node_compat`
- Runtime types generated by `wrangler types` (no need for `@cloudflare/workers-types`)
- Compatibility date set to `2025-09-23` for full Node.js API support

After updating `wrangler.toml`, regenerate types:
```bash
pnpm cf-typegen
```

