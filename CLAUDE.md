# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Jukugi Bokujo (熟議牧場 / Deliberation Ranch)** - A civic tech prototype where users own AI deliberation agents that automatically engage in discussions. This is a放置型思考ゲーム (idle thinking game) where users observe and guide AI agents rather than directly participating in discussions themselves.

### Core Concept
- Users don't debate directly
- AI agents deliberate autonomously
- Users provide direction and knowledge
- Agents gradually adopt user perspectives
- Observation and cultivation are primary interactions

## Architecture

### Monorepo Structure
This is a **pnpm workspace monorepo** with two main applications:

```
apps/
├── backend/    - Cloudflare Workers + Hono API
└── frontend/   - React Router v7 SPA with Clerk auth
```

### Backend (Cloudflare Workers + Hono)
- **Runtime**: Cloudflare Workers (edge computing)
- **Framework**: Hono 4 - lightweight web framework
- **Database**: Cloudflare D1 (SQLite-compatible)
- **Deployment**: Via `wrangler` CLI (NOT Docker for production)
- **Cron Jobs**: Configured in `wrangler.toml` for scheduled tasks
- **Entry Point**: `apps/backend/src/index.ts`

Key backend characteristics:
- No traditional Node.js server - runs on Cloudflare's edge runtime
- D1 database bindings are configured in `wrangler.toml`
- Environment variables in `.dev.vars` for local dev
- Cron triggers for automated deliberation sessions

### Frontend (React Router v7)
- **Framework**: React Router v7 with SPA mode (`ssr: false`)
- **Auth**: Clerk for user authentication
- **Styling**: TailwindCSS v4
- **Build Tool**: Vite
- **App Directory**: `app/` (NOT `src/`)
- **Routes**: Defined in `app/routes.ts` using React Router v7's file-based routing

Key frontend characteristics:
- SPA mode enabled in `react-router.config.ts`
- Clerk components wrapped in root layout
- Hot module replacement in development
- Docker for local development, various platforms for production

## Common Commands

You should use pnpm instead of npm every time.

### Development
```bash
# Install dependencies (from root)
pnpm install

# Docker Compose (alternative - with auto-migration)
docker-compose up              # Both services (migrations run automatically)
docker-compose up backend      # Backend only
docker-compose up frontend     # Frontend only

# Clean start (remove volumes)
docker-compose down -v && docker-compose up

# Formatting, run everytime before commit
pnpm biome:format
pnpm biome:check

# Typecheck
pnpm typecheck
```

### Backend-Specific Commands
```bash
cd apps/backend

# Development
pnpm dev                       # Start Wrangler dev server

# Database operations (D1)
pnpm wrangler d1 create jukugi-bokujo-db                    # Create database
pnpm wrangler d1 execute jukugi-bokujo-db --local \
  --file=./migrations/0001_initial.sql                      # Run migrations locally
pnpm wrangler d1 execute jukugi-bokujo-db --remote \
  --file=./migrations/0001_initial.sql                      # Run migrations on production

# Type generation (Wrangler 4)
pnpm cf-typegen                # Generate Cloudflare Worker runtime types
                               # Run this after updating wrangler.toml

# Deployment (production)
pnpm deploy                    # Deploy to Cloudflare Workers

# Test cron triggers locally
curl "http://localhost:8787/__scheduled?cron=*+*+*+*+*"
```

### Frontend-Specific Commands
```bash
cd apps/frontend

# Development
pnpm dev                       # Start Vite dev server

# Build
pnpm build                     # Production build

# Type checking
pnpm typecheck                 # Run TypeScript type checking

# Start production build locally
pnpm start
```

## Environment Variables

### Backend (.dev.vars)
```bash
CLERK_SECRET_KEY=sk_test_...   # Clerk secret for API authentication
ENVIRONMENT=development
```

### Frontend (.env)
```bash
VITE_CLERK_PUBLISHABLE_KEY=pk_test_...  # Clerk public key
VITE_API_URL=http://localhost:8787      # Backend API URL
```

## Key Technical Constraints

### Backend Deployment
- **NEVER** deploy backend using Docker to production
- Production deployment MUST use `wrangler deploy`
- Docker is only for local development convenience
- Uses Wrangler 4 with `nodejs_compat` compatibility flag for Node.js API support
- Runtime types are auto-generated by `wrangler types` (no `@cloudflare/workers-types` needed)

### Frontend Routing
- Uses React Router v7's new routing system
- Routes defined in `app/routes.ts` (NOT file-based by default)
- App code lives in `app/` directory (NOT `src/`)
- Currently in SPA mode (`ssr: false`)

### D1 Database
- SQLite-compatible syntax
- Bindings configured in `wrangler.toml`
- Use `--local` flag for local development
- Use `--remote` flag for production operations
- Database ID must be set in `wrangler.toml` after creation

## UI Design System

**Rule: Always use design system components for frontend UI.** Never implement buttons, cards, badges, etc. with raw Tailwind classes. Use semantic tokens like `text-muted-foreground` instead of hardcoded colors like `text-gray-600`. See `docs/design-system.md` for full specification.

### shadcn Components (`~/components/ui/`)

```bash
pnpm dlx shadcn@latest add <component>  # Add new component
```

| Component | Usage |
|---|---|
| `Button` | All actions. variant: default/secondary/destructive/outline/ghost/link |
| `Card` | Content container. CardHeader/CardTitle/CardContent/CardFooter |
| `Badge` | Generic label. variant: default/secondary/destructive/outline |
| `Alert` | Notification box. AlertTitle/AlertDescription |
| `Input` | Single-line text input field |
| `Textarea` | Multi-line text input field |
| `Label` | Form field label |
| `AlertDialog` | Modal confirmation dialog |
| `Tabs` | Tab switching UI. TabsList/TabsTrigger/TabsContent |

### Custom Components (`~/components/design-system`)

```tsx
import { LoadingState, StatusBadge, EmptyState } from "~/components/design-system"
```

| Component | Description |
|---|---|
| `Spinner` | Loading spinner. size: sm/md/lg |
| `LoadingState` | Full-page loading state with message |
| `StatusBadge` | Semantic status display. variant: active/completed/pending/cancelled/info/feedback/direction |
| `EmptyState` | Empty data state with optional CTA button |
| `PageHeader` | Page title with optional action slot |
| `BackLink` | Back navigation link to parent page |
| `InfoAlert` | Info/warning box. variant: info/warning/error/feedback/strategy |
| `FormField` | Label + input + character counter integrated field |
| `ConfirmDialog` | Confirmation dialog. Do NOT use `window.confirm` |
| `FilterTabs` | Filter toggle tabs with option list |
| `Pagination` | Page navigation with prev/next buttons |
| `ScoreCard` | Score display card with colored value |

## Code Style

- **Formatting**: Biome
- **Line Width**: 100 characters
- **TypeScript**: Strict mode enabled
- **Import Style**: ES modules (`type: "module"` in package.json)

## Testing Cron Jobs

The backend includes scheduled task support via Cloudflare Cron Triggers:
- Configuration: `wrangler.toml` `[triggers.crons]`
- Handler: `scheduled()` function in `src/index.ts`
- Local testing: `curl "http://localhost:8787/__scheduled?cron=*+*+*+*+*"`
